# ED scoring events

## Предназначение:
Программа является обработчиком событий журнала пилота игры Elite: Dangerous. Она автоматически отслеживает изменения в последнем файле журнала и обрабатывает события в нем, в соответствии с файлом конфигурации (***config\\config.xml***)

###### Что может делать программа, реагируя на события:

1. Проигрывать звуковые файлы с синхронном и асинхронном режимах. Останавливать проигрывание в асинхронном режиме.
2. Проговаривать текст из игры и фразы, определенные пользователем.
3. Изменять голос произношения, его громкость и скорость.
4. В соответствии с параметрами события, принимать то или другое решение.
5. Случайным образом принимать то или другое решение.

## Установка программы:
1. Качаем и устанавливаем синтезаторы голосовдля SAPI (Windows программы) https://rhvoice.ru/languages/ (русские/английские голоса). Так же можно скачать голоса с https://rhvoice.su/voices/ 
2. Качаем последний релиз с гитхаба (Предварительно сохраните папку **%APPDATA%/ELiteVoice**, иначе можете потерять все конфигурационные настройки)
3. Запускаем программу из **Пуск->Программы->EliteVoice C3S->EliteVoice**. Обработка началась. (Программу, без зазрения совести, можно запускать/останавливать в любой момент)

## Синтаксис конфигурации (%APPDATA%\\EliteVoice\\config\\config.xml):

Элемент | Атрибуты | Описание
------- | -------- | --------
Configuration | | Корневой элемент конфигурации
Init | | Секция инициализации программы
Replace | **match** - регулярное выражение для замены текста<br>**replace** - заменяющая строка<br>**ignorecase**[**true**\|false] - регистронезависимая замена | Глобальная замена произносимого текста<br>**!!!Изменения с предыдущей версии**
Event | **name** - имя события или XPAth выражение | Секция события в игре. Все дочерние команды выполняются при возникновении данного события.
Play | **name** - имя проигрывателя<br>**file** - имя звукового файла<br>**volume**[0..100] - уровень громкости<br>**async**[true\|**false**] - асинхронное воспроизведение | Проиграть звуковой файл
Stop | **name** - имя проигрывателя<br>**fade** - время затухания в миллисекундах | Остановить проигрыватель звукового файла. Если параметр **name** отсутствует, то останавливаются все проигрыватели.
TextToSpeech | **voice** - имя голоса озвучки<br>**volume**[0..100] - уровень громкости<br>**rate**[-10..10] - скорость произношения<br> | Установить параметры произношения текста для дочерних элементов или глобально.
Text | **select** - XPAth выражение для выбора произносимого текста | Произнести текст из параметра события или взять его из содержимого элемента.
Pause | **value** - время остановки в миллисекундах | Приостановить выполнение команд на **value** миллисекунд.
Randomize | | Выбрать одну из дочерних команд случайным образом.
Block | **priority**[**1**..] - приоритет выбора блока, чем выше, тем больше вероятность | Блок команд, для элемента Randomize
Switch | **select** - XPAth выражение для выбора елемента | Выбор параметра для условия выбора в дочерних элементах Case/Default
Case | **match\|imatch** - соответствует регулярному выражению<br>**equal\|iequal** - полное соответствие<br>**test** - проверка по  XPAth выражению  | Проверка условия значения параметра, заданного элементом Switch. Префикс **i** у атрибута означает, что сравнение будет регистронезависимым.
Default | | Условие по умолчанию в блоке Switch. Обязательно должен быть **последним** элементом.
If | **test** - проверка по XPAth выражению | Проверка условия, заданного XPAth выражением. Дочерние элементы выполняются, если уловие истинно.
ForEach | **select** - XPAth выражение для выбора набора елементов | Выбор набора элементов, заданного XPAth выражением. 



###### Некоторые пояснения:

В отличии от предыдущей версии программы, которая использовала JSON непосредственно с log-файла, текущая версия преобразует JSON в XML. Это дает преимущество в разборе параметров события, дополнительных вычислений, прохода по структуре и т.п. Например преобразование строки Json события StartJump:
```json
	{ 
	"timestamp":"2021-09-28T02:12:34Z", 
	"event":"StartJump", 
	"JumpType":"Hyperspace", 
	"StarSystem":"Didio", 
	"SystemAddress":3240309573995, 
	"StarClass":"G" 
	}
```
будет преобразован в XML вида:
```xml
	<root>
	   <timestamp>2021-09-28T02:12:34Z</timestamp>
	   <event>StartJump</event>
	   <JumpType>Hyperspace</JumpType>
	   <StarSystem>Didio</StarSystem>
	   <SystemAddress>3240309573995</SystemAddress>
	   <StarClass>G</StarClass>
	</root>
```
Как можно заметить, текущий, для обработки команд, элемент это **"root** поэтому чтобы озвучить, например, название звездной системы, необходимо использовать выражение типа **"//StarSystem"**. В примерах указанных ниже, следует на это обратить внимание.

###### Примеры:

Выполнить блок команд, при возникновении события *SupercruiseEntry* (вход суперкруиз):
```xml
	<Event name="SupercruiseEntry">
	...
	</Event>
```

Установить глобально голос "Anna" с самым быстрым произношением и половиной громкости. Сказать фразу. Переключить на голос "Irina" и среднюю скорость. Сказать фразу. И снова голосом "Anna" сказать фразу. Паузы между произношениями будут составлять 500 миллисекунд.
```xml
	<TextToSpeech voice="Anna" volume="50" rate="10"/>
	<Text>Привет люди! Говорит Анна.</Text>
	<Pause value="500"/>
	<TextToSpeech voice="Irina" rate="0">
		<Text>Ирина вмешивается в процесс</Text>
	</TextToSpeech>
	<Pause value="500"/>
	<Text>А теперь снова будет говорить Анна.</Text>
```


Произнести случайным образом одну из 3х фраз. Вероятность произношения первой фразы - 20%, второй - 50%, третьей - 30%
```xml
	<Randomize>
		<Block priority="2">
			<Text>Первая фраза</Text>
		</Block>
		<Block priority="5">
			<Text>Вторая фраза</Text>
		</Block>
		<Block priority="3">
			<Text>Третья фраза</Text>
		</Block>
	</Randomize>
```

Проиграть звуковой файл на громкости 20%. После его завершения произнести фразу.
```xml
	<Play file="sound\music.mp3" volume="20"/>
	<Text>Музыка кончилась</Text>
```

Начать проигрывание звукового файла на громкости 50%. Через 10 секунд произнести фразу и в течении 5 секунд остановить проигрывание.
```xml
	<Play name="player1" file="sound\music.mp3" volume="50" async="true"/>
	<Pause value="10000"/>
	<Text>Сейчас музыка начнет заканчиваться</Text>
	<Stop name="player1" fade="5000"/>
```

Проверить от кого пришло сообщение в игре и соответственно выбрать, значение какого параметра использовать для произношения сообщения.
```xml
	<Switch select="/*/Channel">
		<Case imatch="(player|wing)">
			<Text select="../Message"/>
		</Case>
		<Default>
			<Text select="../Message_Localised"/>
		</Default>
	</Switch>
```

Секция инициализации. Глобально заменять "мама" на "папа". Заменять "Euryale" на "Эвриала".
```xml
  <Init>
    <Replace match="мама" replace="папа"/>
    <Replace match="Euryale" replace="Эвриала"/>
    ...
  </Init>
```

Проверить обитаема ли система и проговорить голосом численность населения и количество фракций в системе в собылтии FSDJump.
```xml
  <Event name="FSDJump">
    <Switch select="//Population">
      <Case iequal="0">
        <Text>Система необитаемая</Text>
      </Case>
      <Default>
        <Text>Население системы: </Text>
        <Text select="./text()"/>
        <Text>человек</Text>
        <Pause value="500"/>
        <Text>Всего фракций: </Text>
        <Text select="count(../Factions)"/>
        <Pause value="500"/>
        <Text>Контроллирующая фракция: </Text>
        <Text select="../SystemFaction"/>
      </Default>
    </Switch>
  </Event>
```

!!!Важно. В программе присутствует файл настроек **%APPDATA%\\EliteVoice\\log4net\\log4net.config**, в котором настраивается логирование вывода преобразований JSON->XML. Если вам не нужно дебажить вывод XML просто удалите этот файл или, что лучше, замените **DEBUG** на **NONE**.

## Замечания:

1.	Чтобы понять, что RHVoice с вашими голосами подключился, можно посмотреть в дебаг выводе, какие голоса подключены в системе. У меня лично такие:

	**Found voices:**<br>
	Arina<br>
	Alan<br>
	Aleksandr<br>
	Aleksandr+Alan<br>
	Aleksandr-hq<br>
	Anna<br>
	Microsoft Zira Desktop - English (United States)<br>
	Artemiy<br>
	Bdl<br>
	Clb<br>
	Elena<br>
	Evgeniy-Rus<br>
	Irina<br>
	Mikhail<br>
	Pavel<br>
	Slt<br>
	Tatiana<br>
	Tatiana+Clb<br>
	Victoria<br>
	Yuriy<br>

2.  В дебаг выводе можно увидеть, какие события обрабатываются, а какие нет. И соответственно написать/изменить их обработчики.

3.	Конечно в программе присутствуют ошибки. Об ошибках сообщайте мне в [discord](https://discord.gg/c5sm4WS) (ник haps) или на [github](https://github.com/hapsys/elite-voice/issues)
